<%= form_with model: [:admin, @race], class: "space-y-8", data: { controller: "poster-analyzer" } do |f| %>
  <% if @race.errors.any? %>
    <div class="p-4 bg-red-50 text-red-600 rounded-xl text-sm font-medium">
      <ul class="space-y-1">
        <% @race.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <!-- Poster Analyzer Section -->
  <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-[2.5rem] border-2 border-dashed border-blue-300 p-8">
    <h2 class="text-2xl font-black text-gray-900 mb-4 flex items-center">
      <svg class="w-8 h-8 mr-3 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
      </svg>
      ğŸ¯ í¬ìŠ¤í„°ë¡œ ìë™ ì…ë ¥
    </h2>
    <p class="text-gray-600 mb-6">ëŒ€íšŒ í¬ìŠ¤í„°ë¥¼ ì—…ë¡œë“œí•˜ë©´ OCRë¡œ ìë™ìœ¼ë¡œ ì •ë³´ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤</p>

    <!-- Dropzone -->
    <div data-poster-analyzer-target="dropzone" class="border-2 border-dashed border-gray-300 rounded-2xl p-8 text-center bg-white hover:border-blue-400 transition-all cursor-pointer">
      <input type="file"
             accept="image/*"
             class="hidden"
             data-poster-analyzer-target="fileInput"
             data-action="change->poster-analyzer#selectFile">

      <div data-poster-analyzer-target="preview" class="hidden mb-4">
        <img data-poster-analyzer-target="previewImage" class="max-w-sm mx-auto rounded-xl shadow-lg">
      </div>

      <div class="space-y-2">
        <svg class="w-16 h-16 text-gray-400 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
        </svg>
        <p class="text-lg font-bold text-gray-700">ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</p>
        <p class="text-sm text-gray-500">PNG, JPG (ìµœëŒ€ 5MB)</p>

        <button type="button"
                class="mt-4 px-6 py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 transition-all"
                onclick="event.preventDefault(); this.closest('[data-poster-analyzer-target=dropzone]').querySelector('[data-poster-analyzer-target=fileInput]').click()">
          íŒŒì¼ ì„ íƒ
        </button>
      </div>
    </div>

    <!-- Analyze Button -->
    <div class="mt-6 text-center">
      <button type="button"
              data-poster-analyzer-target="analyzeButton"
              data-action="click->poster-analyzer#analyze"
              disabled
              class="px-8 py-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-black rounded-xl hover:from-blue-700 hover:to-indigo-700 transition-all shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
        ğŸ” í¬ìŠ¤í„° ë¶„ì„ ì‹œì‘
      </button>
    </div>

    <!-- Loading State -->
    <div data-poster-analyzer-target="loadingState" class="hidden mt-6">
      <div class="bg-blue-50 border border-blue-200 rounded-2xl p-6">
        <div class="flex items-center space-x-4">
          <svg class="animate-spin h-8 w-8 text-blue-600" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <div>
            <p class="font-bold text-gray-900">OCR ë¶„ì„ ì¤‘...</p>
            <p class="text-sm text-gray-600">ì•½ 10-15ì´ˆ ì†Œìš”ë©ë‹ˆë‹¤</p>
          </div>
        </div>
        <div class="mt-4 bg-gray-200 rounded-full h-2">
          <div class="bg-blue-600 h-2 rounded-full animate-pulse" style="width: 60%"></div>
        </div>
      </div>
    </div>

    <!-- Success State -->
    <div data-poster-analyzer-target="successState" class="hidden mt-6">
      <div class="bg-green-50 border border-green-200 rounded-2xl p-6">
        <div class="flex items-center space-x-3">
          <svg class="w-8 h-8 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <p class="font-bold text-green-900">ë¶„ì„ ì™„ë£Œ! ì •ë³´ê°€ ìë™ìœ¼ë¡œ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤</p>
        </div>
      </div>
    </div>

    <!-- Error Message -->
    <div data-poster-analyzer-target="errorMessage" class="hidden mt-6 bg-red-50 border border-red-200 rounded-2xl p-4 text-red-600 font-medium"></div>

    <!-- Raw Text (ë””ë²„ê¹…ìš©) -->
    <details class="mt-6">
      <summary class="cursor-pointer text-sm font-bold text-gray-500 hover:text-gray-700">ì¶”ì¶œëœ í…ìŠ¤íŠ¸ ë³´ê¸° (ë””ë²„ê¹…ìš©)</summary>
      <pre data-poster-analyzer-target="rawText" class="mt-2 p-4 bg-gray-100 rounded-xl text-xs overflow-auto max-h-48"></pre>
    </details>
  </div>

  <!-- Basic Info Section -->
  <div class="bg-white rounded-[2.5rem] shadow-sm border border-gray-100 p-8">
    <h2 class="text-xl font-black text-gray-900 mb-6 flex items-center">
      <span class="w-2 h-6 bg-blue-600 rounded-full mr-3"></span>
      ê¸°ë³¸ ì •ë³´
    </h2>

    <div class="space-y-6">
      <!-- Title -->
      <div>
        <%= f.label :title, "ëŒ€íšŒëª…", class: "block text-sm font-bold text-gray-700 mb-2" %>
        <%= f.text_field :title, placeholder: "2026 ì„œìš¸ ê³µì‹ ì˜¤í† ", class: "block w-full px-5 py-4 rounded-2xl border-gray-200 focus:ring-blue-500 focus:border-blue-500 shadow-sm transition-all", data: { poster_analyzer_target: "titleField" } %>
      </div>

      <!-- Description -->
      <div>
        <%= f.label :description, "ëŒ€íšŒ ì„¤ëª…", class: "block text-sm font-bold text-gray-700 mb-2" %>
        <%= f.text_area :description, rows: 4, placeholder: "ëŒ€íšŒì— ëŒ€í•œ ìƒì„¸ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”", class: "block w-full px-5 py-4 rounded-2xl border-gray-200 focus:ring-blue-500 focus:border-blue-500 shadow-sm transition-all", data: { poster_analyzer_target: "descriptionField" } %>
      </div>

      <!-- Location & Organizer -->
      <div class="grid grid-cols-2 gap-4">
        <div>
          <%= f.label :location, "ì¥ì†Œ", class: "block text-sm font-bold text-gray-700 mb-2" %>
          <%= f.text_field :location, placeholder: "ì„œìš¸ ì ì‹¤ì¢…í•©ìš´ë™ì¥", class: "block w-full px-5 py-4 rounded-2xl border-gray-200 focus:ring-blue-500 focus:border-blue-500 shadow-sm transition-all", data: { poster_analyzer_target: "locationField" } %>
        </div>
        <div>
          <%= f.label :organizer_name, "ì£¼ìµœ", class: "block text-sm font-bold text-gray-700 mb-2" %>
          <%= f.text_field :organizer_name, placeholder: "ì„œìš¸ì‹œì²´ìœ¡íšŒ", class: "block w-full px-5 py-4 rounded-2xl border-gray-200 focus:ring-blue-500 focus:border-blue-500 shadow-sm transition-all", data: { poster_analyzer_target: "organizerField" } %>
        </div>
      </div>

      <!-- Official Website URL -->
      <div>
        <%= f.label :official_site_url, "ê³µì‹ ì›¹ì‚¬ì´íŠ¸", class: "block text-sm font-bold text-gray-700 mb-2" %>
        <%= f.url_field :official_site_url, placeholder: "https://example.com", class: "block w-full px-5 py-4 rounded-2xl border-gray-200 focus:ring-blue-500 focus:border-blue-500 shadow-sm transition-all", data: { poster_analyzer_target: "officialSiteField" } %>
      </div>

      <!-- Thumbnail Image -->
      <div>
        <%= f.label :thumbnail, "ì¸ë„¤ì¼ ì´ë¯¸ì§€", class: "block text-sm font-bold text-gray-700 mb-2" %>
        <div class="space-y-4">
          <!-- File Upload -->
          <div data-controller="avatar-preview">
            <div class="flex items-start space-x-4">
              <div class="flex-shrink-0">
                <% if @race.thumbnail.attached? %>
                  <%= image_tag @race.thumbnail.variant(:thumb), class: "w-32 h-24 object-cover rounded-xl border border-gray-200", data: { avatar_preview_target: "preview" } %>
                <% else %>
                  <div class="w-32 h-24 bg-gray-100 rounded-xl border border-gray-200 flex items-center justify-center" data-avatar-preview-target="placeholder">
                    <svg class="w-8 h-8 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                  </div>
                  <img data-avatar-preview-target="preview" class="w-32 h-24 object-cover rounded-xl border border-gray-200 hidden">
                <% end %>
              </div>
              <div class="flex-1">
                <%= f.file_field :thumbnail, accept: "image/*", class: "block w-full text-sm text-gray-500 file:mr-4 file:py-3 file:px-6 file:rounded-xl file:border-0 file:text-sm file:font-bold file:bg-blue-50 file:text-blue-600 hover:file:bg-blue-100 cursor-pointer", data: { action: "change->avatar-preview#preview", avatar_preview_target: "input" } %>
                <p class="mt-2 text-xs text-gray-500">PNG, JPG, GIF (ìµœëŒ€ 5MB)</p>
              </div>
            </div>
          </div>

          <!-- OR divider -->
          <div class="relative">
            <div class="absolute inset-0 flex items-center">
              <div class="w-full border-t border-gray-200"></div>
            </div>
            <div class="relative flex justify-center text-xs">
              <span class="px-2 bg-white text-gray-500 font-bold">ë˜ëŠ”</span>
            </div>
          </div>

          <!-- URL Input -->
          <div>
            <%= f.label :thumbnail_url, "ì¸ë„¤ì¼ ì´ë¯¸ì§€ URL", class: "block text-xs font-bold text-gray-600 mb-1" %>
            <%= f.url_field :thumbnail_url, placeholder: "https://example.com/image.jpg", class: "block w-full px-4 py-3 rounded-xl border-gray-200 focus:ring-blue-500 focus:border-blue-500 shadow-sm transition-all text-sm" %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Date & Status Section -->
  <div class="bg-white rounded-[2.5rem] shadow-sm border border-gray-100 p-8">
    <h2 class="text-xl font-black text-gray-900 mb-6 flex items-center">
      <span class="w-2 h-6 bg-indigo-600 rounded-full mr-3"></span>
      ì¼ì • ë° ìƒíƒœ
    </h2>

    <div class="space-y-6">
      <!-- Race Date -->
      <div>
        <%= f.label :start_at, "ëŒ€íšŒ ê°œìµœì¼", class: "block text-sm font-bold text-gray-700 mb-2" %>
        <%= f.datetime_local_field :start_at, class: "block w-full px-5 py-4 rounded-2xl border-gray-200 focus:ring-blue-500 focus:border-blue-500 shadow-sm transition-all", data: { poster_analyzer_target: "startAtField" } %>
      </div>

      <!-- Registration Period -->
      <div class="grid grid-cols-2 gap-4">
        <div>
          <%= f.label :registration_start_at, "ì ‘ìˆ˜ ì‹œì‘ì¼", class: "block text-sm font-bold text-gray-700 mb-2" %>
          <%= f.datetime_local_field :registration_start_at, class: "block w-full px-5 py-4 rounded-2xl border-gray-200 focus:ring-blue-500 focus:border-blue-500 shadow-sm transition-all", data: { poster_analyzer_target: "registrationStartAtField" } %>
        </div>
        <div>
          <%= f.label :registration_end_at, "ì ‘ìˆ˜ ë§ˆê°ì¼", class: "block text-sm font-bold text-gray-700 mb-2" %>
          <%= f.datetime_local_field :registration_end_at, class: "block w-full px-5 py-4 rounded-2xl border-gray-200 focus:ring-blue-500 focus:border-blue-500 shadow-sm transition-all", data: { poster_analyzer_target: "registrationEndAtField" } %>
        </div>
      </div>

      <!-- Refund Deadline -->
      <div>
        <%= f.label :refund_deadline, "í™˜ë¶ˆ ë§ˆê°ì¼", class: "block text-sm font-bold text-gray-700 mb-2" %>
        <%= f.datetime_local_field :refund_deadline, class: "block w-full px-5 py-4 rounded-2xl border-gray-200 focus:ring-blue-500 focus:border-blue-500 shadow-sm transition-all", data: { poster_analyzer_target: "refundDeadlineField" } %>
      </div>

      <!-- Status & Official Record -->
      <div class="grid grid-cols-2 gap-4">
        <div>
          <%= f.label :status, "ìƒíƒœ", class: "block text-sm font-bold text-gray-700 mb-2" %>
          <%= f.select :status,
              [["ì„ì‹œì €ì¥", "draft"], ["ì ‘ìˆ˜ì¤‘", "open"], ["ë§ˆê°", "closed"], ["ì¢…ë£Œ", "finished"]],
              {},
              class: "block w-full px-5 py-4 rounded-2xl border-gray-200 focus:ring-blue-500 focus:border-blue-500 shadow-sm transition-all" %>
        </div>
        <div class="flex items-end">
          <label class="flex items-center cursor-pointer">
            <%= f.check_box :is_official_record, class: "h-5 w-5 text-blue-600 focus:ring-blue-500 border-gray-300 rounded mr-3", data: { poster_analyzer_target: "isOfficialRecordField" } %>
            <span class="text-sm font-bold text-gray-700">ê³µì¸ ê¸°ë¡ ëŒ€íšŒ</span>
          </label>
        </div>
      </div>
    </div>
  </div>

  <!-- Race Editions Section -->
  <div class="bg-white rounded-[2.5rem] shadow-sm border border-gray-100 p-8">
    <h2 class="text-xl font-black text-gray-900 mb-6 flex items-center">
      <span class="w-2 h-6 bg-green-600 rounded-full mr-3"></span>
      ì¢…ëª© ì„¤ì •
    </h2>

    <div id="race-editions" data-poster-analyzer-target="editionsContainer">
      <%= f.fields_for :race_editions do |edition_form| %>
        <div class="race-edition-fields nested-fields bg-gray-50 rounded-2xl p-6 mb-4">
          <div class="grid grid-cols-4 gap-4 mb-4">
            <div>
              <%= edition_form.label :name, "ì¢…ëª©ëª…", class: "block text-sm font-bold text-gray-700 mb-2" %>
              <%= edition_form.text_field :name, placeholder: "10K", class: "block w-full px-4 py-3 rounded-xl border-gray-200 focus:ring-blue-500 focus:border-blue-500 shadow-sm text-sm" %>
            </div>
            <div>
              <%= edition_form.label :distance, "ê±°ë¦¬ (km)", class: "block text-sm font-bold text-gray-700 mb-2" %>
              <%= edition_form.number_field :distance, step: 0.001, placeholder: "10", class: "block w-full px-4 py-3 rounded-xl border-gray-200 focus:ring-blue-500 focus:border-blue-500 shadow-sm text-sm" %>
            </div>
            <div>
              <%= edition_form.label :price, "ì°¸ê°€ë¹„ (ì›)", class: "block text-sm font-bold text-gray-700 mb-2" %>
              <%= edition_form.number_field :price, placeholder: "30000", class: "block w-full px-4 py-3 rounded-xl border-gray-200 focus:ring-blue-500 focus:border-blue-500 shadow-sm text-sm" %>
            </div>
            <div>
              <%= edition_form.label :capacity, "ì •ì›", class: "block text-sm font-bold text-gray-700 mb-2" %>
              <%= edition_form.number_field :capacity, placeholder: "1000", class: "block w-full px-4 py-3 rounded-xl border-gray-200 focus:ring-blue-500 focus:border-blue-500 shadow-sm text-sm" %>
            </div>
          </div>
          <div class="grid grid-cols-3 gap-4">
            <div>
              <%= edition_form.label :age_limit_min, "ìµœì†Œ ë‚˜ì´", class: "block text-sm font-bold text-gray-700 mb-2" %>
              <%= edition_form.number_field :age_limit_min, placeholder: "18", class: "block w-full px-4 py-3 rounded-xl border-gray-200 focus:ring-blue-500 focus:border-blue-500 shadow-sm text-sm" %>
            </div>
            <div>
              <%= edition_form.label :age_limit_max, "ìµœëŒ€ ë‚˜ì´", class: "block text-sm font-bold text-gray-700 mb-2" %>
              <%= edition_form.number_field :age_limit_max, placeholder: "65", class: "block w-full px-4 py-3 rounded-xl border-gray-200 focus:ring-blue-500 focus:border-blue-500 shadow-sm text-sm" %>
            </div>
            <div>
              <%= edition_form.label :display_order, "ì •ë ¬ ìˆœì„œ", class: "block text-sm font-bold text-gray-700 mb-2" %>
              <%= edition_form.number_field :display_order, placeholder: "1", class: "block w-full px-4 py-3 rounded-xl border-gray-200 focus:ring-blue-500 focus:border-blue-500 shadow-sm text-sm" %>
            </div>
          </div>

          <% unless edition_form.object.new_record? %>
            <div class="mt-4">
              <%= edition_form.check_box :_destroy, class: "h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded" %>
              <%= edition_form.label :_destroy, "ì´ ì¢…ëª© ì‚­ì œ", class: "text-sm font-bold text-red-600 ml-2" %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>

    <button type="button" id="add-edition" class="inline-flex items-center px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold rounded-xl transition-all text-sm">
      <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
      ì¢…ëª© ì¶”ê°€
    </button>
  </div>

  <!-- Submit Buttons -->
  <div class="flex items-center justify-between pt-6">
    <%= link_to "ì·¨ì†Œ", admin_races_path, class: "px-8 py-4 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold rounded-2xl transition-all" %>
    <%= f.submit @race.new_record? ? "ëŒ€íšŒ ë“±ë¡" : "ë³€ê²½ì‚¬í•­ ì €ì¥", class: "px-8 py-4 bg-blue-600 hover:bg-blue-700 text-white font-black rounded-2xl shadow-xl shadow-blue-100 transition-all active:scale-[0.98] cursor-pointer" %>
  </div>
<% end %>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const addButton = document.getElementById('add-edition');
  const container = document.getElementById('race-editions');

  if (addButton) {
    addButton.addEventListener('click', function() {
      const time = new Date().getTime();
      const regexp = new RegExp('new_race_editions', 'g');
      const newFields = container.querySelector('.race-edition-fields').outerHTML.replace(regexp, time);
      container.insertAdjacentHTML('beforeend', newFields);
    });
  }
});
</script>
